Here I've just documented various issues I've encountered throughout this project.

# Emscripten Forge

## Outdated Local build Documentation

The setup guide I was following for emscripten forged had the following issues.

### Pip Install Incorrect Branch Name
___
* The branch name used when installing the boa python package is incorrect. The command given is,
```
python -m pip install git+https://github.com/DerThorsten/boa.git@postcb --no-deps --ignore-installed
```

This results in an import error when attempting to run Builder.py. The branch that needs to be installed is `python_api`. Therefor the command should instead be,

```
python -m pip install git+https://github.com/DerThorsten/boa.git@python_api --no-deps --ignore-installed
```

### Version Mismatch in .emsdkdir
___

The version used when piping the install location to .emsdkdir is hardcoded. You may need to double check that the directory is correct for the version of emsdk you are using.

For example, my file contained `/home/mbatc/.cache/empack/emsdk-3.1.2` when it should have instead been `/home/mbatc/.cache/empack/emsdk-3.1.27`


# Fix Common Build Issues

Below are some common build issues and the fixes/workarounds for these.

## relocation R_WASM_MEMORY_ADDR_TLS_SLEB cannot be used

**cause**: This often occurs when building an executable (using `add_executable`). To fix this, we need to add `-fPIC` to the compile flags. 
**fix**: Add the following to the CMakeLists.txt

```
if (EMSCRIPTEN)
  target_compile_options(<target_name> PUBLIC -fPIC)
endif()
```

where `target_name` is the name of the target failing to compile with this linker error.

## Executable extension is .js instead of .wasm

**cause**: emcmake defaults executable extensions to `.js`. This produces a linker warning. Although it is not an error, we expect executables to have a .wasm extension.
**fix**: Add the following to the CMakeLists.txt

```
set_target_properties(
  <target_name>
  PROPERTIES SUFFIX ".wasm"
)
```

where `target_name` is the name of the target failing to compile with this linker error.

## Micromamba: Nothing provides requested <package-name>
This error occurs when a package is listed as a dependency by a recipe, but the package is not
available in any of the channelâ€™s searched by Conda (e.g., Conda Forge, Emscripten Forge,
Robostack Staging, etc.). This may be because the package is pinned to a specific version which is not available, or there are no versions of the package available. If there are no packages available, then we will need to build it. If the package is a Conda Forge
package, then we will need to port the package from Conda Forge to Emscripten Forge and build it.

If it is a ROS package, then the recipe was not generated by Vinca. To make Vinca generate the
recipe it will need to be added to the packages_select_by_deps in vinca_emscripten_32.yaml

## Emcc: Unable to Find Input (.so or .a)
This is likely because the dependency is missing from the recipes host build requirements and not installed into the build environment. If the recipe is generated by Vinca then we can added the dependency via the dependencies.yaml file. Simply add a key with the name of the package being build and add an add_host entry with the name of the dependency. For example, if fmt could not be linked when building ros-humble-rcl-logging-spdlog we would add,

```yaml
rcl_logging_spdlog:
  add_host: [ "fmt" ]
```

Note that you will need to find the name of the package that provides the library being linked, this will not necessarily be the same as the name of the library.

## Emcc: Linking the Threading Library

find_package(Threads REQUIRED) always fails. The FindThreads.cmake script doesn't support
emscripten and emscripten does not proved an implementation for this. A solution could be to
provide a find_package implementation that simply adds -pthread to the compiler options.
Symptoms of a missing threading library are,

```
wasm-ld: error: --shared-memory is disallowed by <source_file>.o because it was not
compiled with 'atomics' or 'bulk-memory' features.
```
In general, you can try adding this to the CMakeLists.txt file,

```cmake
if (EMSCRIPTEN)
  set(CMAKE_CXX_FLAGS "-pthread ${CMAKE_CXX_FLAGS}")
endif()
```

## wasm-ld: unkown argument

Some builds have produced errors when linking with `wasm-ld` as it does not support all the flags that C++ linker supports. An example error output is,
```
wasm-ld: error: unknown argument: --sort-common
wasm-ld: error: unknown argument: --as-needed
wasm-ld: error: unknown argument: --disable-new-dtags
```

There are two solutions to this,
1. After the CMakesList.txt project is generated, remove the offending flags from the
CMakeCache.txt file.
2. Modify the UNSUPPORTED_LLD_FLAGS dictionary in `emcc.py/em++.py` to include the
flags. You must add an entry to the dictionary for each flag that is not supported. An example based on the errors shown above is,
```py
UNSUPPORTED_LLD_FLAGS = {
...
'--sort-common': False,
'--as-needed': False,
'--disable-new-dtags': False,
}
```

## wasm-ld: undefined symbol: __stack_chk_guard
This is related to -fstack-protector switch which is not supported by emcc. In general, you can try adding this to the CMakeLists.txt file,

```cmake
if (EMSCRIPTEN)
  string(REPLACE "-fstack-protector-strong" "" CMAKE_CXX_FLAGS
"${CMAKE_CXX_FLAGS}")
endif()
```
## Google Benchmark CMake Error
CMake error produced in the build is,
```
CMake Error at CMakeLists.txt:261 (message):

Failed to determine the source files for the regular expression backend.

This is an issue in the Google Benchmark CMake project. It uses `try_run` to compile test exe's, however CMake does not run the exe when cross compiling. The variables being tested need to be manually set.
```

The error is raised in this section of the google benchmark CMakeLists.txt
```cmake
# C++ feature checks
# Determine the correct regular expression engine to use
cxx_feature_check(STD_REGEX ${EXTRA_CXX_FLAGS})
cxx_feature_check(GNU_POSIX_REGEX ${EXTRA_CXX_FLAGS})
cxx_feature_check(POSIX_REGEX ${EXTRA_CXX_FLAGS})
if(NOT HAVE_STD_REGEX AND NOT HAVE_GNU_POSIX_REGEX AND NOT
HAVE_POSIX_REGEX)
message(FATAL_ERROR "Failed to determine the source files for the regular expression
backend")
endif()
```

The `cxx_feature_check` does not appear to function correctly when cross-compiling to web
assembly. This specific error occurred when adding an external project. This means that the
additional CMake variables need to be defined in the `externalproject_add` call.

## Unsupported compiler flags
`-march` and `-mtune` are not supported. To remove these flags, add the following to the
CMakeLists.txt
```cmake
if (EMSCRIPTEN)
  string(REPLACE "-march=nocona" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
  string(REPLACE "-mtune=haswell" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
endif()
```
